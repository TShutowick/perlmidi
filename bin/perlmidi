#!/usr/bin/env perl

use strict;
use warnings;

use Getopt::Long;
use Pod::Usage;

BEGIN {
	use FindBin qw/$Bin/;
	unshift @INC, "$Bin/../lib";
}

use PerlMIDI::Parser;
use PerlMIDI::Device;
use PerlMIDI::Sequencer;
use PerlMIDI::Constants;

# $dir should be a directory containing .yml files with MIDI tracks
# $dev_path should be a path to a MIDI device, or '/dev/stdout' for testing
my $dir;
my $dev_path = '/dev/stdout';
my $input_path;
my $tempo;
my $help;

GetOptions(
	'dir=s'      => \$dir,
	'device=s'   => \$dev_path,
	'tempo=i'    => \$tempo,
	'help|?'     => \$help,
	'input=s'    => \$input_path,
) or pod2usage(2);

if ($tempo && $input_path) {
	pod2usage("-message" => "Cannot specify both --tempo and --input");
}

$tempo ||= 100;  # Default tempo is 100 BPM

pod2usage(1) if $help;

pod2usage("-message" => "Directory not specified", "-exitval" => 2) unless $dir;

my @files = glob( "$dir/*.yml") or die "no files in $dir";
my @tracks = map { PerlMIDI::Parser::load_file(path => $_) } @files;

my $device = PerlMIDI::Device->new(path => $dev_path);
my $input_device;
if ($input_path) {
	$input_device = PerlMIDI::Device->new(
		path => $input_path,
		mode => '<',
	);
}

my $seq = PerlMIDI::Sequencer->new(
	bpm    => $tempo,
	device => $device,
	tracks => \@tracks,
);

while(1) {
	if ($input_device) {
		my $bytes = $input_device->read_bytes(1)
			or last;
		if ($bytes->[0] eq BYTE_CLOCK) {
			$seq->tick();
		}
	} else {
		$seq->tick();
	}
}

__END__

=head1 NAME

perlmidi.pl - A simple MIDI sequencer in Perl

=head1 SYNOPSIS

perlmidi.pl --dir /path/to/data --device /dev/midi0 --tempo 120

=head1 OPTIONS

=over 8

=item B<--dir>

Directory containing MIDI sequences in YAML format.

=item B<--device>

Path to the MIDI device to send output to. Defaults to '/dev/stdout'.

=item B<--tempo>

Sets the tempo in beats per minute. Defaults to 100.

=item B<--help>

Prints this help message and exits.

=item B<--input>

Path to a MIDI input device. If specified, the sequencer will read MIDI clock signals from this device instead of ticking automatically.

=back

=cut
